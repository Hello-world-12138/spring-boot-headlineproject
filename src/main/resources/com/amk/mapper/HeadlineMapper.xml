<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.amk.mapper.HeadlineMapper">

    <resultMap id="BaseResultMap" type="com.amk.pojo.Headline">
        <id property="hid" column="hid" />
        <result property="title" column="title" />
        <result property="article" column="article" />
        <result property="type" column="type" />
        <result property="publisher" column="publisher" />
        <result property="pageViews" column="page_views" />
        <result property="status" column="status" />
        <result property="createTime" column="create_time" />
        <result property="updateTime" column="update_time" />
        <result property="version" column="version" />
        <result property="isDeleted" column="is_deleted" />
    </resultMap>

    <sql id="Base_Column_List">
        hid,title,article,type,publisher,page_views,status,
        create_time,update_time,version,is_deleted
    </sql>


    <!-- 自定义分页查询的方法 -->
    <select id="selectMyPage" resultType="java.util.Map">
        select h.hid,h.title,h.type,h.page_views pageViews,TIMESTAMPDIFF(HOUR,h.create_time,NOW()) pastHours,
        h.publisher
        from news_headline h
        left join news_user u on h.publisher = u.uid
        where h.is_deleted=0 and h.status=1 and (u.role is null or u.role != -1)
        <if test="portalVo.keyWords !=null and portalVo.keyWords.length()>0 ">
            and h.title like concat('%',#{portalVo.keyWords},'%')
        </if>
        <if test="portalVo.type != 0">
            and h.type = #{portalVo.type}
        </if>
    </select>

    <select id="queryDetailMap" resultType="map">
        select h.hid,h.title,h.article,h.type, h.version ,t.tname typeName ,h.page_views pageViews
             ,TIMESTAMPDIFF(HOUR,h.create_time,NOW()) pastHours,h.publisher,h.status
                 ,u.nick_name author,u.role as publisherRole
            from news_headline h
                left join news_type t on h.type = t.tid
                left join news_user u  on h.publisher = u.uid
            where h.hid = #{hid} and h.is_deleted = 0
    </select>


    <!-- 查询浏览记录（关键：用 AS 别名确保返回 title） -->
    <select id="selectBrowseHistory" resultType="map">
        SELECT
            h.hid,
            h.title,
            h.page_views AS pageViews,
            TIMESTAMPDIFF(HOUR, bh.browse_time, NOW()) AS pastHours
        FROM browse_history bh
                 LEFT JOIN news_headline h ON bh.hid = h.hid
                 LEFT JOIN news_user u ON h.publisher = u.uid
        WHERE bh.uid = #{userId}
          AND h.is_deleted = 0
          AND h.status = 1
          AND (u.role IS NULL OR u.role != -1)
        ORDER BY bh.browse_time DESC
            LIMIT 20
    </select>

    <!-- 管理端分页查询头条列表 -->
    <select id="selectAdminPage" resultType="map">
        select
            h.hid,
            h.title,
            h.create_time    as createTime,
            h.status,
            h.article,
            u.nick_name      as author
        from news_headline h
                 left join news_user u on h.publisher = u.uid
        where h.is_deleted = 0
        <if test="status != null and status != -1">
            and h.status = #{status}
        </if>
        order by h.create_time desc
    </select>

    <update id="approveHeadline">
        update news_headline
        set status = 1,
            update_time = now()
        where hid = #{hid} and is_deleted = 0
    </update>

    <select id="selectTopHeadlines" resultType="map">
        select
            h.hid,
            h.title,
            h.page_views as pageViews,
            u.nick_name as author
        from news_headline h
                 left join news_user u on h.publisher = u.uid
        where h.is_deleted = 0 and h.status = 1
        order by h.page_views desc
        limit 10
    </select>

    <select id="selectHeadlineTrend" resultType="map">
        select
            DATE(create_time) as dt,
            count(*) as cnt
        from news_headline
        where is_deleted = 0
          and create_time >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        group by DATE(create_time)
        order by dt
    </select>

    <update id="batchUpdateStatusByPublisher">
        update news_headline
        set status = #{status},
            update_time = now()
        where publisher = #{publisher}
    </update>

</mapper>
